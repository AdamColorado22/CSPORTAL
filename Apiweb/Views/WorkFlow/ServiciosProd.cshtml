
@{
    ViewBag.Title = "ServiciosProd";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="~/Content/js/jquery-3.5.1.js"></script>
@*<script src="~/Content/js/jquery.auto-complete.js"></script>*@
<link href="~/Content/bootstrap.css" rel="stylesheet" />
<script src="~/Content/js/bootstrap.js"></script>
@*<link href="~/Content/bootstrap.min.css" rel="stylesheet" />*@
<link href="~/Content/Site.css" rel="stylesheet" />
<script src="~/Content/js/toastr.min.js"></script>
<link href="~/Content/css/toastr.min.css" rel="stylesheet" />
@*<script src="~/Content/js/bootstrap-datepicker.es.js"></script>*@


<div class="row m-4">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header">
                SERVICIOS PRODUCCION
            </div>
            <div class="card-body">
                <table class="table table-striped table-bordered" id="DTable" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>TIPO</th>
                            <th>NOMBRE PRODUCTO</th>
                            <th>DESCRIPCION</th>
                            <th>IDCLIENTE</th>
                            <th>DUI</th>
                            <th>PERSONA_ASIGNADA</th>
                            <th>TRABAJO_REALIZADO</th>
                            <th>COMENTARIOS</th>
                            <th>PROCESO_ACTUAL</th>
                            <th>FECHA_INICIO</th>
                            <th>TIEMPO_PROCESO</th>
                            <th>TIEMPO_TOTAL</th>
                            <th>FECHA_ESTIMADA</th>
                            <th>FECHA_FINALIZACION</th>
                            <th>DIAS_TOTALES</th>
                            <th>PASO_ACTUAL</th>



                        </tr>
                    </thead>

                </table>
            </div>
        </div>

    </div>

</div>


@*!--ARchivos -->*@
<div class="modal fade " id="FormModal6" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow Adjuntar CoA y FT</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container">
                    @*@using (Html.BeginForm("SubirArchivo", "Workflow",FormMethod.Post,new { id= "frm-adjuntar" }))
                        {*@
                    <form id="uploader">
                        <input type="hidden" id="idWorkflow" name="idWorkflow" />
                        <div class="row">
                            <div class="col-sm-6">
                                <input id="fileInput" type="file" multiple>
                            </div>
                            <div class="col-md-6 left">
                                <button type="submit" id="btnsubmit" class="btn btn-sm btn-primary">
                                    <span class="glyphicon glyphicon-open"></span>
                                    &nbsp;Subir archivo
                                </button>
                            </div>
                        </div>
                        @*}*@
                    </form>
                    <hr />
                    <div class="row">
                        <input type="hidden" id="txtguiid" />
                        <table class="table table-sm" id="Adjuntos" style="width:100%">
                            <thead>
                                <tr>

                                    <th>FECHA SUBIDA</th>
                                    <th>NOMBRE</th>
                                    <th>DESCARGAS</th>


                                </tr>
                            </thead>

                        </table>

                    </div>
                </div>
            </div>
            @*<div class="modal-footer">

                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="Siguiente()">Guardar</button>

                </div>*@

        </div>

    </div>
</div>


@*!-- Modal Agregar o editar -->*@
<div class="modal fade" id="FormModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <div class="form-row">


                    <input type="hidden" id="txtid" />

                    <div class="form-group col-md-6">
                        <label for="txttiporeq">Nombre Producto:</label>
                        <input type="text" autocomplete="off" class="form-control" id="txttiporeq">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="txtdescripcion">Descripcion:</label>
                        <input type="text" autocomplete="off" class="form-control" id="txtdescripcion">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="txtclientes">Cliente:</label>
                        <input type="text" autocomplete="off" class="form-control" id="txtclientes">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="txtdui">Dui:</label>
                        <input type="text" autocomplete="off" class="form-control" id="txtdui">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="datepicker">FECHA ESTIMADA:</label>
                        <input type="text" id="datepicker" class="form-control" autocomplete="off">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="txtpersonaa">Persona Asignada:</label>
                        <select class="form-control" id="txtpersonaa">
                            @*<option value="Servicio">Servicio</option>*@
                            <option value="Omar Rivas">Omar Rivas</option>
                            <option value="Alex Rosales">Alex Rosales</option>
                            <option value="Geovanny Argueta">Geovanny Argueta</option>
                            <option value="David Argueta.">David Argueta</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                <button type="button" id="btnguardari" class="btn btn-primary" onclick="Guardar()">Guardar</button>
            </div>
            @*<div class="form-group col-md-6">
                    <button type="submit" class="btn btn-sm btn-secondary btn-block">Subir archivo</button>
                </div>*@

            @*}*@

        </div>

    </div>
</div>



<div class="modal fade" id="FormModal3" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label for="txttrabrealizado">Trabajo Realizado:</label>
                        <select class="form-control" id="txttrabrealizado">
                           
                            <option selected value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>


                    </div>
                    <div class="form-group col-md-12">
                        <label for="txtcomentarios">Comentarios:</label>
                        <input type="text" autocomplete="off" class="form-control" id="txtcomentarios">
                    </div>
                  

                </div>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Siguiente()">Guardar</button>

            </div>

        </div>

    </div>
</div>


@section scripts
    {


    <script>

        var table, tableA;
        $("#exampleModal").draggable({
            handle: ".modal-header"
        });

        $('#datepicker').datepicker({
            uiLibrary: 'bootstrap4',
            dateFormat: 'dd/mm/yy'
        });
        $('#datepicker2').datepicker({
            uiLibrary: 'bootstrap4',
            dateFormat: 'dd/mm/yy'
        });
        $('#datepicker4').datepicker({
            uiLibrary: 'bootstrap4',
            dateFormat: 'dd/mm/yy'
        });
        $('#datepicker5').datepicker({
            uiLibrary: 'bootstrap4',
            dateFormat: 'dd/mm/yy'
        });
        $('#FormModal6').on('hidden.bs.modal', function (e) {
            tableA.destroy();
        })


        $('#WorkflowServicio').addClass('active');
        $('#WorkflowMuestra').removeClass('active');
        $('#Workflowbart').removeClass('active');
        $('#Workflowb2b').removeClass('active');
        $('#Bodega1').removeClass('active');
        $('#navhist').removeClass('active');
        $('#navsmi').removeClass("active");
        $('#navmh').removeClass("active");
        $('#navhome').removeClass("active");
        $('#navqw2').removeClass("active");
        $('#navqw7').removeClass("active");
        $('#navqw62').removeClass("active");

        $(document).ready(function () {



            mostrar();


            document.getElementById('uploader').onsubmit = function () {
                var formdata = new FormData(); //FormData object
                var idworkflow = document.getElementById('idWorkflow').value;
                var fileInput = document.getElementById('fileInput');

                //Iterating through each files selected in fileInput
                formdata.append('idWorkflow', idworkflow);
                formdata.append('tipo', 'PRO');
                for (i = 0; i < fileInput.files.length; i++) {
                    //Appending each file to FormData object
                    formdata.append(fileInput.files[i].name, fileInput.files[i]);
                }
                //Creating an XMLHttpRequest and sending
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/Workflow/SubirArchivo');
                xhr.send(formdata);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        //toastr.success('Archivo Adjuntado', 'Completado', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                        tableA.destroy();
                        tableA.ajax.reload();

                        archivos(table.rows({ selected: true }).data()[0].ID);
                        //limpiar();
                    }
                }
                return false;
            }



        });

        function archivos($ID) {
            $("#idWorkflow").val($ID);
            TablaAdjuntos($ID);
            $('#FormModal6').modal('show');
        }


        function mostrar()
        {

            table = $('#DTable').DataTable({
                responsive: true,
                dom: "Bfrltip",
                "scrollY": "500px",
                "iDisplayLength": -1,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                ajax: "/Workflow/ListaServiciosProd",
                columns: [
                    { data: "ID" },
                    { data: "TIPO" },
                    { data: "TIPO_REQUERIMIENTO" },
                    { data: "DESCRIPCION" },
                    { data: "IDCLIENTE" },
                    { data: "DUI" },
                    { data: "PERSONA_ASIGNADA" },
                    { data: "TRABAJO_REALIZADO" },
                    { data: "COMENTARIOS" },
                    { data: "PROCESO_ACTUAL" },
                    { data: "FECHA_INICIO" },

                    {
                        data: null,
                        title: "TIEMPO PROCESO",
                        render: function (data, row, meta) {
                            var cumplimiento, estilo;
                            if (data.TIEMPO_PROCESO > 0) {
                                cumplimiento = (data.TIEMPO_PROCESO * 100).toFixed(2);
                                if (cumplimiento > 0 && cumplimiento < 40) {
                                    estilo = 'width:' + cumplimiento + '%; background-color: green';
                                }
                                else if (cumplimiento >= 40 && cumplimiento < 80) {

                                    estilo = 'width:' + cumplimiento + '%; background-color: yellow';
                                }
                                else if (cumplimiento >= 80) {

                                    estilo = 'width:' + cumplimiento + '%; background-color: red';
                                }

                            }
                            else
                                cumplimiento = 0;
                            return '<div class="progress"> <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="' + estilo + '" aria-valuenow="' + cumplimiento + '" aria-valuemin="0" aria-valuemax="100"> <span style="color:black" >' + cumplimiento + '% </span></div></div>';

                        }
                    },
                    {
                        data: null,
                        title: "TIEMPO TOTAL",
                        render: function (data, row, meta) {
                            var cumplimiento, estilo;
                            if (data.TIEMPO_TOTAL > 0) {
                                cumplimiento = (data.TIEMPO_TOTAL * 100).toFixed(2);
                                if (cumplimiento > 0 && cumplimiento < 40) {
                                    estilo = 'width:' + cumplimiento + '%; background-color: green';
                                }
                                else if (cumplimiento >= 40 && cumplimiento < 80) {

                                    estilo = 'width:' + cumplimiento + '%; background-color: yellow';
                                }
                                else if (cumplimiento >= 80) {

                                    estilo = 'width:' + cumplimiento + '%; background-color: red';
                                }

                            }
                            else
                                cumplimiento = 0;
                            return '<div class="progress"> <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="' + estilo + '" aria-valuenow="' + cumplimiento + '" aria-valuemin="0" aria-valuemax="100"> <span style="color:black" >' + cumplimiento + '% </span></div></div>';

                        }
                    },
                    { data: "FECHA_ESTIMADA" },
                    { data: "FECHA_FINALIZACION" },

                    { data: "DIAS_TOTALES" },
                    { data: "PASO_ACTUAL" },




                ],

                order: [0, 'asc'],

                select: true,
                buttons: [

                    {
                        text: '<a ><i class="fas fa-plus-circle fa-lg"  style="color:#007bff"></i>&nbsp; Nuevo</a>',
                        titleAttr: 'Agregar Nuevo',
                        action: function (e, dt, node, config) {
                            $('#btnguardari').prop("disabled", false);
                            $('#FormModal').modal('show');
                        }
                    },

                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel" style="color:green"></i> ',
                        titleAttr: 'Exportar a Excel',
                        className: 'btn btn-success btn-sm'
                    },
                   {
                        extend: 'print',
                        text: '<i class="fa fa-print"></i> ',
                        titleAttr: 'Print',
                        className: 'btn btn-info'
                    },

                    {
                        text: '<i class="fas fa-check-square"></i>',
                        extend: 'selectAll',
                        className: 'btn-space'
                    },
                    {
                        text: '<i class="far fa-check-square"></i>',
                        extend: 'selectNone',
                        className: 'btn-space'
                    },
                    {
                        text: '<i class="fas fa-sync-alt" style="color:green"></i>',
                        titleAttr: 'Actualizar',
                        action: function (e, dt, node, config) {
                            $('#DTable').DataTable().ajax.reload();

                        }
                    },
                    {
                        text: '<a><i class="fas fa-caret-square-right" style="color:#229E51"></i>&nbsp; Siguiente Proceso</a>',
                        titleAttr: 'Siguiente',
                        action: function (e, dt, node, config) {
                            if (table.rows('.selected').data().length > 0) { Paso(table.rows({ selected: true }).data()[0].PASO_ACTUAL); }
                            else {
                                toastr.error('Debe Seleccionar al menos un Registro', 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            }

                        }
                    },
                    {
                        text: '<i class="fas fa-link"></i>',
                        titleAttr: 'Adjuntos',
                        action: function (e, dt, node, config) {
                            if (table.rows('.selected').data().length > 0) { archivos(table.rows({ selected: true }).data()[0].ID); }
                            else {
                                toastr.error('Debe Seleccionar al menos un Registro y en estado Finalizado', 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            }

                        }
                    },



                ],
                language: {
                   url: "@Url.Content("~/Content/idioma/datatable.es-ES.json")"
                }
            });
        }

        function Paso($CORREL) {

            switch ($CORREL)

            {
                case 10:
                    $('#FormModal3').modal('show');
                    break;
                case 20:
                    Siguiente()
                    break;


            }
        }


             function TablaAdjuntos($ID)
        {
           /* $.fn.dataTable.moment('DD/MM/YYYY');*/


            tableA= $('#Adjuntos').DataTable({
                responsive: true,
                dom: "Bfrltip",
                "scrollY": "500px",
                "iDisplayLength": 10,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                ajax: "/Workflow/Ver?idworkflow=" + $ID +"&tipo=PRO",


                columns: [

                    { data: "Extension" },
                    /*{ data: "Nombre" },*/
                    {
                        data: "Nombre", "render": function (data, type, row) {

                            return "<a  href='/Workflow/DescargarArchivo/?id=" + row.Id + "'><i class='fas fa-cloud-download-alt'></i> " + row.Nombre  + "</a>"

                        }

                    },
                    { data: "Descargas" },



                ],

                buttons: [
                    {
                        text: '<a ><i class="fas fa-trash" style="color:red" ></i></a>',
                        titleAttr: 'Eliminar',
                        action: function (e, dt, node, config) {
                            if (table.rows('.selected').data().length > 0) { Eliminar(tableA.rows({ selected: true }).data()[0].Id); }
                            else {
                                toastr.error('Debe Seleccionar al menos un Registro', 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            }
                        }
                    },],

                order: [0, 'asc'],

                select: true,

                language: {
                   url: "@Url.Content("~/Content/idioma/es-ES.json")"
                }
            });
        }

        function limpiar() {
            table.clear().draw();
            table.destroy();
            mostrar();
        }


        function Siguiente() {

            var Seleccion = table.rows({ selected: true }).data()[0];

            switch (Seleccion.PASO_ACTUAL) {

                case 10:
                    Seleccion.TRABAJO_REALIZADO = $("#txttrabrealizado").val();
                    Seleccion.COMENTARIOS = $("#txtcomentarios").val();
                   
                    var adicional = { TIPO: "PRO" };
                    Object.assign(Seleccion, adicional);
                    break;

                case 20:
                  

                    var adicional = { TIPO: "PRO" };
                    Object.assign(Seleccion, adicional);
                    break;
              

            }



            jQuery.ajax({
                    url: "@Url.Action("SiguientePro", "Workflow")",
                    type: "POST",
                data: JSON.stringify({ objeto: Seleccion }),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                 success: function (response) {
                     if (response.success === true) {
                          toastr.success(response.message, 'Completado', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            $('#FormModal').modal('hide');
                            limpiar();

                        }
                        else { toastr.error(response.message, 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" }); }
                    }

            });

           
            $('#FormModal2').modal('hide');
            $('#FormModal3').modal('hide');
            
        }

        function Guardar()
        {
                var Workflow = {
                    ID: 0,
                    PASO_ACTUAL: 10,
                    TIPO_REQUERIMIENTO: $("#txttiporeq").val(),
                    DESCRIPCION: $("#txtdescripcion").val(),
                    IDCLIENTE: $("#txtclientes").val(),
                    DUI: $("#txtdui").val(),
                    FECHA_REQUERIDA: $("#datepicker").val(),
                    PERSONA_ASIGNADA: $("#txtpersonaa").val()

                }



             jQuery.ajax({
                    url: "@Url.Action("GuardarProd", "Workflow")",
                    type: "POST",
                 data: JSON.stringify({ objeto: Workflow }),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                 success: function (response) {
                     if (response.success === true) {
                          toastr.success(response.message, 'Completado', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            $('#FormModal').modal('hide');
                            limpiar();

                        }
                        else { toastr.error(response.message, 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" }); }
                    }



             });



        }

    </script>




}