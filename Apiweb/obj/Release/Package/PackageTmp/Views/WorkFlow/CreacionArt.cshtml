
@{
    ViewBag.Title = "CreacionArt";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script src="~/Content/js/jquery-3.5.1.js"></script>
@*<script src="~/Content/js/jquery.auto-complete.js"></script>*@
<link href="~/Content/bootstrap.css" rel="stylesheet" />
<script src="~/Content/js/bootstrap.js"></script>
@*<link href="~/Content/bootstrap.min.css" rel="stylesheet" />*@
<link href="~/Content/Site.css" rel="stylesheet" />
<script src="~/Content/js/toastr.min.js"></script>
<link href="~/Content/css/toastr.min.css" rel="stylesheet" />

<div class="row m-4">
    <div class="col-sm-12">
        <div class="card">
            <div class="card-header">
                Creacion Articulo
            </div>
            <div class="card-body">
                <table class="table table-striped table-bordered" id="DTable" style="width:100%">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>NUM_PEDIDO</th>
                            <th>NOMBRE_PRODUCTO</th>
                            <th>VALIDACION</th>
                            <th>CARTILLA_CALIDAD</th>
                            <th>NUM_CARTILLA</th>
                            <th>TIPO_PEDIDO</th>
                            <th>FECHA_ENTREGA</th>
                            <th>FECHA_VALIDACION_IMP</th>
                            <th>PASO ACTUAL</th>
                            <th>PROCESO ACTUAL</th>
                            <th>FECHA INICIO</th>
                            <th>TIEMPO TOTAL</th>
                            <th>TIEMPO PROCESO</th>
                            <th>FECHA FINALIZACION</th>
                            <th>DIAS TOTALES</th>
                            <th>FECHA ESTIMADA</th>

                        </tr>
                    </thead>

                </table>
            </div>
        </div>

    </div>

</div>




@*!--Paso 20 -->*@
<div class="modal fade" id="FormModal21" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">


                    <input type="hidden" id="txtid" />

                    <div class="form-group col-md-12">
                        <label for="txtpedido">NUMERO PEDIDO:</label>
                        <input type="text" class="form-control" id="txtpedido">
                    </div>
                    <div class="form-group col-md-12">
                        <label for="txtvalidacion">VALIDACION:</label>
                        <select class="form-control" id="txtvalidacion">
                            <option value="CALIDAD">CALIDAD</option>
                            <option value="VENTAS">VENTAS</option>
                            <option value="CLIENTE">CLIENTE</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="txtcartillas">CARTILLAS CALIDAD:</label>
                        <select class="form-control" id="txtcartillas">
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label for="txtncartillas">NUMERO CARTILLAS:</label>
                        <input type="text" class="form-control" id="txtncartillas">
                    </div>

                    <div class="form-group col-md-4">
                        <label for="txttipo"><br>TIPO:</label>
                        <select class="form-control" id="txttipo">
                            <option value="NUEVO">NUEVO</option>
                            <option value="REPETICION">REPETICION</option>
                        </select>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="txtnotas">NOTAS PEDIDO:</label>
                        <textarea class="form-control" id="txtnotas" rows="3"></textarea>

                    </div>

                </div>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Siguiente()">Guardar</button>

            </div>

        </div>

    </div>
</div>


@*!--Paso 30 -->*@
<div class="modal fade" id="FormModal3" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">


                    <input type="hidden" id="txtid" />

                    <div class="form-group col-md-12">
                        <label for="datepicker">FECHA ENTREGA:</label>
                        <input type="text" id="datepicker" class="form-control" autocomplete="off">
                    </div>

                    <div class="form-group col-md-12">
                        <label for="datepicker2">FECHA ENTREGA VALIDACION DE IMPRESION:</label>
                        <input type="text" id="datepicker2" class="form-control" autocomplete="off">
                    </div>

                </div>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Siguiente()">Guardar</button>

            </div>

        </div>

    </div>
</div>

@*!--Paso 40 -->*@
<div class="modal fade" id="FormModal4" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">

                    <div class="form-group col-md-12">
                        <label for="txtestado4"><br>ESTADO:</label>
                        <select class="form-control" id="txtestado4">
                            <option value="APROVADO">APROVADO</option>
                            <option value="RECHAZADO">RECHAZADO</option>
                        </select>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="txtobservaciones">OBSERVACIONES:</label>
                        <textarea class="form-control" id="txtobservaciones" rows="3"></textarea>

                    </div>



                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="Siguiente()">Guardar</button>

                </div>
            </div>


        </div>

    </div>
</div>


@*!--Paso 50 -->*@
<div class="modal fade" id="FormModaltp" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">


                    <input type="hidden" id="txtid" />

                    <div class="form-group col-md-12">
                        <label for="txtformulae">FORMULA A EXTRUIR:</label>
                        <input type="text" class="form-control" id="txtformulae">
                    </div>
                    <div class="form-group col-md-12">
                        <label for="txtcantidadm">CANTIDAD MAXIMA PEDIDO:</label>
                        <input type="text" class="form-control" id="txtcantidadm">
                    </div>

                </div>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Siguiente()">Guardar</button>

            </div>

        </div>

    </div>
</div>



@*!--Paso 50 -->*@
<div class="modal fade" id="FormModal5" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">


                    <input type="hidden" id="txtid" />

                    <div class="form-group col-md-12">
                        <label for="txtunidadventa">UNIDAD DE VENTA:</label>
                        <input type="text" class="form-control" id="txtunidadventa">
                    </div>
                    <div class="form-group col-md-12">
                        <label for="txtmargen">MARGEN:</label>
                        <input type="text" class="form-control" id="txtmargen">
                    </div>

                    <div class="form-group col-md-12">
                        <label for="txtmuestra">NECESITA MUESTRA:</label>
                        <select class="form-control" id="txtmuestra">
                            <option value="SI">SI</option>
                            <option value="NO">NO</option>
                        </select>


                    </div>

                </div>
            </div>
            <div class="modal-footer">

                <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Siguiente()">Guardar</button>

            </div>

        </div>

    </div>
</div>



@*!--ARchivos -->*@
<div class="modal fade " id="FormModal6" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Workflow</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body ">
                <div class="container">
                    @*@using (Html.BeginForm("SubirArchivo", "Workflow",FormMethod.Post,new { id= "frm-adjuntar" }))
                        {*@
                    <form id="uploader">
                        <input type="hidden" id="idWorkflow" name="idWorkflow" />
                        <div class="row">
                            <div class="col-sm-6">
                                <input id="fileInput" type="file" multiple>
                            </div>
                            <div class="col-md-6 left">
                                <button type="submit" id="btnsubmit" class="btn btn-sm btn-primary">
                                    <span class="glyphicon glyphicon-open"></span>
                                    &nbsp;Subir archivo
                                </button>
                            </div>
                        </div>
                        @*}*@
                    </form>
                    <hr />
                    <div class="row">
                        <input type="hidden" id="txtguiid" />
                        <table class="table table-sm" id="Adjuntos" style="width:100%">
                            <thead>
                                <tr>

                                    <th>FECHA SUBIDA</th>
                                    <th>NOMBRE</th>
                                    <th>DESCARGAS</th>


                                </tr>
                            </thead>

                        </table>

                    </div>
                </div>
            </div>
            @*<div class="modal-footer">

                    <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="Siguiente()">Guardar</button>

                </div>*@

        </div>

    </div>
</div>
@section scripts
    {


    <script>
        var table, tableA;
        $("#exampleModal").draggable({
            handle: ".modal-header"
        });

        $('#datepicker').datepicker({
            uiLibrary: 'bootstrap4',
            dateFormat: 'dd/mm/yy'
        });
        $('#datepicker2').datepicker({
            uiLibrary: 'bootstrap4',
            dateFormat: 'dd/mm/yy'
        });
        $('#FormModal6').on('hidden.bs.modal', function (e) {
            tableA.destroy();
        })
        $('#Workflowbart').addClass('active');
        $('#Workflowb2b').removeClass('active');
        $('#Bodega1').removeClass('active');
        $('#navhist').removeClass('active');
        $('#navsmi').removeClass("active");
        $('#navmh').removeClass("active");
        $('#navhome').removeClass("active");
        $('#navqw2').removeClass("active");
        $('#navqw7').removeClass("active");
        $('#navqw62').removeClass("active");

        $(document).ready(function () {

            mostrar();

            document.getElementById('uploader').onsubmit = function () {
                var formdata = new FormData(); //FormData object
                var idworkflow = document.getElementById('idWorkflow').value;
                var fileInput = document.getElementById('fileInput');

                //Iterating through each files selected in fileInput
                formdata.append('idWorkflow', idworkflow);
                formdata.append('tipo', 'ART');
                for (i = 0; i < fileInput.files.length; i++) {
                    //Appending each file to FormData object
                    formdata.append(fileInput.files[i].name, fileInput.files[i]);
                }
                //Creating an XMLHttpRequest and sending
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/Workflow/SubirArchivo');
                xhr.send(formdata);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        //toastr.success('Archivo Adjuntado', 'Completado', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                        tableA.destroy();
                        tableA.ajax.reload();

                        archivos(table.rows({ selected: true }).data()[0].ID);
                        //limpiar();
                    }
                }
                return false;
            }



        });

        function archivos($ID) {
            $("#idWorkflow").val($ID);
            TablaAdjuntos($ID);
            $('#FormModal6').modal('show');
        }


        function mostrar()
        {

            table = $('#DTable').DataTable({
                responsive: true,
                dom: "Bfrltip",
                "scrollY": "500px",
                "iDisplayLength": -1,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                ajax: "/Workflow/ListarCrea",


                columns: [
                    { data: "ID" },
                    { data: "NUM_PEDIDO" },
                    { data: "TITULO" },
                    { data: "VALIDACION" },
                    { data: "CARTILLA_CALIDAD" },
                    { data: "NUM_CARTILLA" },
                    { data: "TIPO_PEDIDO" },
                    { data: "FECHA_ENTREGA" },
                    { data: "FECHA_VALIDACION_IMP" },
                    { data: "PASO_ACTUAL" },
                    { data: "PROCESO_ACTUAL" },
                    { data: "FECHA_INICIO" },
                    {
                        data: null,
                        title: "TIEMPO PROCESO",
                        render: function (data, row, meta) {
                            var cumplimiento, estilo;
                            if (data.TIEMPO_PROCESO > 0) {
                                cumplimiento = (data.TIEMPO_PROCESO * 100).toFixed(2);
                                if (cumplimiento > 0 && cumplimiento < 40) {
                                    estilo = 'width:' + cumplimiento + '%; background-color: green';
                                }
                                else if (cumplimiento >= 40 && cumplimiento < 80) {

                                    estilo = 'width:' + cumplimiento + '%; background-color: yellow';
                                }
                                else if (cumplimiento >= 80) {

                                    estilo = 'width:' + cumplimiento + '%; background-color: red';
                                }

                            }
                            else
                                cumplimiento = 0;
                            return '<div class="progress"> <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="' + estilo + '" aria-valuenow="' + cumplimiento + '" aria-valuemin="0" aria-valuemax="100"> <span style="color:black" >' + cumplimiento + '% </span></div></div>';

                        }
                    },
                    {
                        data: null,
                        title: "TIEMPO TOTAL",
                        render: function (data, row, meta) {
                            var cumplimiento, estilo;
                            if (data.TIEMPO_TOTAL > 0) {
                                cumplimiento = (data.TIEMPO_TOTAL * 100).toFixed(2);
                                if (cumplimiento > 0 && cumplimiento < 40) {
                                    estilo = 'width:' + cumplimiento + '%; background-color: green';
                                }
                                else if (cumplimiento >= 40 && cumplimiento < 80) {

                                    estilo = 'width:' + cumplimiento + '%; background-color: yellow';
                                }
                                else if (cumplimiento >= 80) {

                                    estilo = 'width:' + cumplimiento + '%; background-color: red';
                                }

                            }
                            else
                                cumplimiento = 0;
                            return '<div class="progress"> <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="' + estilo + '" aria-valuenow="' + cumplimiento + '" aria-valuemin="0" aria-valuemax="100"> <span style="color:black" >' + cumplimiento + '% </span></div></div>';

                        }
                    },
                    { data: "FECHA_FINALIZACION" },

                    { data: "DIAS_TOTALES" },
                    { data: "FECHA_ESTIMADA" },



                ],

                order: [0, 'asc'],

                select: true,
                buttons: [


                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel" style="color:green"></i> ',
                        titleAttr: 'Exportar a Excel',
                        className: 'btn btn-success btn-sm'
                    },
                   {
                        extend: 'print',
                        text: '<i class="fa fa-print"></i> ',
                        titleAttr: 'Print',
                        className: 'btn btn-info'
                    },

                    {
                        text: '<i class="fas fa-check-square"></i>',
                        extend: 'selectAll',
                        className: 'btn-space'
                    },
                    {
                        text: '<i class="far fa-check-square"></i>',
                        extend: 'selectNone',
                        className: 'btn-space'
                    },
                    {
                        text: '<i class="fas fa-sync-alt" style="color:green"></i>',
                        titleAttr: 'Actualizar',
                        action: function (e, dt, node, config) {
                            $('#DTable').DataTable().ajax.reload();

                        }
                    },
                    {
                        text: '<a><i class="fas fa-caret-square-right" style="color:#229E51"></i>&nbsp; Siguiente Proceso</a>',
                        titleAttr: 'Siguiente',
                        action: function (e, dt, node, config) {
                            if (table.rows('.selected').data().length > 0) { Paso(table.rows({ selected: true }).data()[0].PASO_ACTUAL); }
                            else {
                                toastr.error('Debe Seleccionar al menos un Registro', 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            }

                        }
                    },
                    {
                        text: '<i class="fas fa-link"></i>',
                        titleAttr: 'Adjuntos',
                        action: function (e, dt, node, config) {
                            if (table.rows('.selected').data().length > 0) { archivos(table.rows({ selected: true }).data()[0].ID); }
                            else {
                                toastr.error('Debe Seleccionar al menos un Registro y en estado Finalizado', 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            }

                        }
                    },



                ],
                language: {
                   url: "@Url.Content("~/Content/idioma/datatable.es-ES.json")"
                }
            });
        }

        function Paso($CORREL) {

            switch ($CORREL)

            {
                case 10:
                    $('#FormModaltp').modal('show');
                    break;
                case 20:
                    Siguiente();
                    break;
                case 30:
                    $('#FormModal21').modal('show');
                    break;
                case 40:
                    $('#FormModal3').modal('show');
                    break;
                case 50:
                    $('#FormModal4').modal('show');
                    break;


            }
        }


             function TablaAdjuntos($ID)
        {
           /* $.fn.dataTable.moment('DD/MM/YYYY');*/


            tableA= $('#Adjuntos').DataTable({
                responsive: true,
                dom: "Bfrltip",
                "scrollY": "500px",
                "iDisplayLength": 10,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                ajax: "/Workflow/Ver?idworkflow=" + $ID+"&tipo=ART",


                columns: [

                    { data: "Extension" },
                    /*{ data: "Nombre" },*/
                    {
                        data: "Nombre", "render": function (data, type, row) {

                            return "<a  href='/Workflow/DescargarArchivo/?id=" + row.Id + "'><i class='fas fa-cloud-download-alt'></i> " + row.Nombre  + "</a>"

                        }

                    },
                    { data: "Descargas" },



                ],

                buttons: [
                    {
                        text: '<a ><i class="fas fa-trash" style="color:red" ></i></a>',
                        titleAttr: 'Eliminar',
                        action: function (e, dt, node, config) {
                            if (table.rows('.selected').data().length > 0) { Eliminar(tableA.rows({ selected: true }).data()[0].Id); }
                            else {
                                toastr.error('Debe Seleccionar al menos un Registro', 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            }
                        }
                    },],

                order: [0, 'asc'],

                select: true,

                language: {
                   url: "@Url.Content("~/Content/idioma/es-ES.json")"
                }
            });
        }



        function limpiar()
        {
            table.clear().draw();
            table.destroy();
            mostrar();
        }

        function Siguiente() {

            var Seleccion = table.rows({ selected: true }).data()[0];

            switch (Seleccion.PASO_ACTUAL) {

                case 10:

                    var adicional = { TIPO: "ART", FORMULA_EXT: $("#txtformulae").val(), CANTIDAD_MAX: $("#txtcantidadm").val() };
                    Object.assign(Seleccion, adicional);
                    break;
                case 20:

                    var adicional = { TIPO: "ART" };
                    Object.assign(Seleccion, adicional);
                    break;
                case 30:
                    Seleccion.TIPO_PEDIDO = $("#txtpedido").val();
                    Seleccion.VALIDACION = $("#txtvalidacion").val();
                    Seleccion.CARTILLA_CALIDAD = $("#txtcartillas").val();
                    Seleccion.NUM_CARTILLA = $("#txtncartillas").val();
                    Seleccion.TIPO_PEDIDO = $("#txttipo").val();
                    var adicional = { NOTAS_PEDIDO: $("#txtnotas").val(), TIPO: "ART" };
                    Object.assign(Seleccion, adicional);
                    break;
                case 40:
                    Seleccion.FECHA_ENTREGA = $("#datepicker").val();
                    Seleccion.FECHA_VALIDACION_IMP = $("#datepicker2").val();
                    var adicional = {  TIPO: "ART" };
                    Object.assign(Seleccion, adicional);
                    break;
                case 50:
                    var adicional = { OBSERVACIONES: $("#txtobservaciones").val(), ESTADO: $("#txtestado4").val(), TIPO: "ART" };
                    Object.assign(Seleccion, adicional);
                    break;

            }



            jQuery.ajax({
                    url: "@Url.Action("SiguienteArt", "Workflow")",
                    type: "POST",
                data: JSON.stringify({ objeto: Seleccion }),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                 success: function (response) {
                     if (response.success === true) {
                          toastr.success(response.message, 'Completado', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            $('#FormModal').modal('hide');
                            limpiar();

                        }
                        else { toastr.error(response.message, 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" }); }
                    }

            });
            
            $('#FormModaltp').modal('hide');
            $('#FormModal21').modal('hide');
            $('#FormModal2').modal('hide');
            $('#FormModal3').modal('hide');
            $('#FormModal4').modal('hide');
            $('#FormModal5').modal('hide');
        }

        function Guardar($CLIENTE_CORREL)
        {
                var Workflow = {
                    ID: 0,
                    TITULO: $("#txttitulo").val(),
                    PASO_ACTUAL: 10
                }



             jQuery.ajax({
                    url: "@Url.Action("GuardarArt","Workflow")",
                    type: "POST",
                 data: JSON.stringify({ objeto: Workflow }),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                 success: function (response) {
                     if (response.success === true) {
                          toastr.success(response.message, 'Completado', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" });
                            $('#FormModal').modal('hide');
                            limpiar();

                        }
                        else { toastr.error(response.message, 'Alerta', { timeOut: 3000, "closeButton": true, "positionClass": "toast-top-left" }); }
                    }



             });



        }

    </script>




}

