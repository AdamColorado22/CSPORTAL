USE [TERMOAPP]
GO
/****** Object:  StoredProcedure [dbo].[TER_COM_CREA_PEDIDOS_NIC]    Script Date: 14/06/2023 17:50:57 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

----EXEC [dbo].[TER_COM_CREA_PEDIDOS_NIC] '311','acolorado'

--Creado por :Adam Colorado 
--Fecha Creacion: 2023-02-22 
--Modificado por :Adam Colorado
--Fecha Modificacion: 2023-06-08
--Descripcion: Cambios por inclusion de UN y Fechas de pedidos
ALTER PROCEDURE [dbo].[TER_COM_CREA_PEDIDOS_NIC]
@ID_PED varchar(100),
 @USUARIO VARCHAR(50)
AS
BEGIN
DECLARE @BASE VARCHAR(50),
@SERVER VARCHAR(50)
SELECT  @BASE='TERMO',@SERVER=''
DECLARE 
 @TOTAL_O DECIMAL (18,4),
@SQL NVARCHAR(MAX),
 @ID_O VARCHAR(40),
 @params NVARCHAR(255) = '@ID NVARCHAR(40) OUTPUT',
 @params2 NVARCHAR(255) = '@TOTAL DECIMAL (18,4) OUTPUT',
  @params3 NVARCHAR(255) = '@CUSTOMER_REF NVARCHAR(40) OUTPUT'
 


DECLARE  @CUSTOMER_ID VARCHAR(40),
@PART_ID VARCHAR(50),
@CUSTOMER_PART_ID VARCHAR(50),
@QUANTITY DECIMAL (18,4),
@PRICE DECIMAL (18,4),
@CUSTOMER_REF_O VARCHAR(50),
@PO VARCHAR(100)='',
@TIPO VARCHAR(50),
@TOLERANCIA VARCHAR(50),
@DESIRED_SHIP_DATE VARCHAR(50),
@FECHADESPACHO VARCHAR(50),
@REF_COTIZA VARCHAR(50),
@OC VARCHAR(50),
 @ID_CURSOR INT,
 @CUSTOMER_ID2 VARCHAR(40),
  @CUST_ACTUAL VARCHAR(40),
	  @OC2 VARCHAR(40),
	  @LINE INT,
	   @Error int,
	   @CARTILLA VARCHAR(500),
 @CARTILLAS VARCHAR(500),
  @STATUS_PED VARCHAR(2)
 BEGIN TRAN
-- Crear tabla temporal para almacenar valores separados
DECLARE @ID_PED_TEMP TABLE (ID INT);

-- Insertar valores en tabla temporal
INSERT INTO @ID_PED_TEMP (ID)
SELECT ID.value('.', 'INT')
FROM (SELECT CAST('<M>' + REPLACE(@ID_PED, ',', '</M><M>') + '</M>' AS XML)) AS A(ID_XML)
CROSS APPLY ID_XML.nodes('/M') AS B(ID);

	 
   
   SELECT CLIENTE,ID,CONVERT(DATE,FECHA_INGRESO,103) FECHA_ENTREGA,TIPO,TOLERANCIA,REF_COTIZACION,OC,CARTILLA ,CONVERT(DATE,FECHADESPACHO,103) FECHADESPACHO INTO #TEMP FROM TER_COM_PEDIDOS WHERE ESTADO IN ('NUEVO','AUTORIZADO') AND ( PART_ID IS NOT NULL OR PART_ID <>'' ) AND IDUSUARIO=@USUARIO   AND ID  in (SELECT ID FROM @ID_PED_TEMP)
  	 DECLARE PEDIDOS1 CURSOR FOR   
SELECT 'NI-TERNIC' AS CLIENTE,OC,CLIENTE AS ACTUAL FROM #TEMP GROUP BY CLIENTE,OC
  

    OPEN PEDIDOS1  
    FETCH NEXT FROM PEDIDOS1 INTO   @CUSTOMER_ID2,@OC2,@CUST_ACTUAL
  
  
    WHILE @@FETCH_STATUS = 0  
    BEGIN  

 SET @SQL =' SELECT @ID= ALPHA_PREFIX+ RIGHT(''00000'' + Ltrim(Rtrim(NEXT_NUMBER)),5)+ALPHA_SUFFIX FROM '+@BASE+'.DBO.NEXT_NUMBER_GEN WHERE TABLE_NAME = ''CUSTOMER_ORDER'' and SITE_ID=(select top 1 ID from '+@BASE+'.DBO.site)'

 EXEC  sp_executeSQL  @SQL,@params,@ID =  @ID_O OUTPUT;
	
 
PRINT  @ID_O

--SELECT @ID= ALPHA_PREFIX+ RIGHT('00000' + Ltrim(Rtrim(NEXT_NUMBER)),5)+ALPHA_SUFFIX FROM TEXPORT9.DBO.NEXT_NUMBER_GEN WHERE TABLE_NAME = 'CUSTOMER_ORDER' and SITE_ID='TEXPO'		
		

SET @SQL = 'SELECT @TOTAL= SUM(CANTIDAD*(COSTO/0.82))  FROM  TER_COM_PEDIDOS WHERE  OC='''+@OC2+''' AND  ESTADO IN (''NUEVO'',''AUTORIZADO'')    AND ID IN ('+@ID_PED+')  AND IDUSUARIO='''+@USUARIO+''''

 EXEC  sp_executeSQL  @SQL,@params2,@TOTAL =  @TOTAL_O OUTPUT;

 SELECT TOP 1 @STATUS_PED=ESTADO_PED FROM  TER_COM_PEDIDOS WHERE ESTADO IN ('NUEVO','AUTORIZADO') AND ( PART_ID IS NOT NULL OR PART_ID <>'' ) AND IDUSUARIO=@USUARIO   AND ID  in (SELECT ID FROM @ID_PED_TEMP)
 
   if @STATUS_PED is null or @STATUS_PED='' 
 begin
 set @STATUS_PED='F'
 end
 
SET @SQL = 'SELECT TOP 1 @CUSTOMER_REF= OC FROM  TER_COM_PEDIDOS WHERE   OC='''+@OC2+''' AND  ESTADO IN (''NUEVO'',''AUTORIZADO'') AND  ID IN ('+@ID_PED+')  AND IDUSUARIO='''+@USUARIO+''''

 EXEC  sp_executeSQL  @SQL,@params3,@CUSTOMER_REF =  @CUSTOMER_REF_O OUTPUT;


 PRINT 'INSERT'
 

 SET @SQL =' INSERT INTO '+@BASE+'.[dbo].[CUSTOMER_ORDER] (
                  ID, CUSTOMER_ID,CUSTOMER_PO_REF,SITE_ID,TERMS_NET_TYPE,TERMS_DISC_TYPE,FREIGHT_TERMS,ORDER_DATE,DESIRED_SHIP_DATE,BACK_ORDER,STATUS,SELL_RATE,
                   BUY_RATE,POSTING_CANDIDATE,TOTAL_AMT_ORDERED,TOTAL_AMT_SHIPPED,MARKED_FOR_PURGE,EDI_FLAG,EXCH_RATE_FIXED,SALESREP_ID,
                   CURRENCY_ID, CREATE_DATE, CONSIGNMENT, STATUS_EFF_DATE, 
                   CONTACT_FIRST_NAME, CONTACT_LAST_NAME, CONTACT_INITIAL, CONTACT_POSITION, CONTACT_HONORIFIC, CONTACT_SALUTATION, CONTACT_PHONE, 
                   CONTACT_FAX, SHIP_TO_ADDR_NO, TERMS_NET_DAYS, TERMS_NET_DATE, TERMS_DESCRIPTION, ACCEPT_EARLY, DAYS_EARLY, TERMS_ID, 
                   CONTACT_ID) 
                   select '''+@ID_O+''' as ID, C.ID AS CUSTOMER_ID,'''+@CUSTOMER_REF_O+''' AS CUSTOMER_PO_REF,(select top 1 ID from '+@BASE+'.DBO.site) AS SITE_ID,C.TERMS_NET_TYPE AS TERMS_NET_TYPE,C.TERMS_DISC_TYPE AS TERMS_DISC_TYPE,C.FREIGHT_TERMS AS FREIGHT_TERMS,convert(date,getdate()) AS ORDER_DATE,convert(date,getdate()) AS DESIRED_SHIP_DATE,''N'' AS BACK_ORDER,'''+@STATUS_PED+''' AS STATUS,1.0000000 AS SELL_RATE,
                   1.0000000 AS BUY_RATE,''N'' AS POSTING_CANDIDATE,0.00 AS TOTAL_AMT_ORDERED,0.00 AS TOTAL_AMT_SHIPPED,''N'' AS MARKED_FOR_PURGE,''N'' AS EDI_FLAG,''N'' AS EXCH_RATE_FIXED, C.SALESREP_ID AS SALESREP_ID,
                   CURRENCY_ID,GETDATE() AS CREATE_DATE,''N'' AS CONSIGNMENT,GETDATE() AS STATUS_EFF_DATE,
                   C.CONTACT_FIRST_NAME, C.CONTACT_LAST_NAME, C.CONTACT_INITIAL, C.CONTACT_POSITION, C.CONTACT_HONORIFIC,C.CONTACT_SALUTATION, C.CONTACT_PHONE,
                   C.CONTACT_FAX, null AS SHIP_TO_ADDR_NO,C.TERMS_NET_DAYS,C.TERMS_NET_DATE, C.TERMS_DESCRIPTION, C.ACCEPT_EARLY, C.DAYS_EARLY, C.DEF_TERMS_ID AS TERMS_ID,
                   (SELECT TOP 1 CONTACT_ID FROM '+@BASE+'.DBO.CUST_CONTACT WHERE CUSTOMER_ID = C.ID) AS CONTACT_ID
                   from '+@BASE+'.DBO.CUSTOMER C where  C.id ='''+@CUSTOMER_ID2+''''


 EXEC  sp_executeSQL  @SQL
SET @Error=@@ERROR
 IF (@Error<>0) GOTO TratarError
 PRINT 'CUR'
 SET @SQL ='INSERT INTO '+@BASE+'.DBO.CUST_ORDER_CURR ( CUST_ORDER_ID, CURRENCY_ID, AMOUNT, SELL_RATE, BUY_RATE ) VALUES ( '''+@ID_O+''',''USD'','+str(@TOTAL_O,13,4)+',1.00000000,1.00000000)'
 

 EXEC  sp_executeSQL  @SQL
 SET @Error=@@ERROR
 IF (@Error<>0) GOTO TratarError
 PRINT 'LINES'
   SET @LINE=1

 DECLARE PEDIDOS CURSOR FOR   
 SELECT * FROM #TEMP WHERE CLIENTE=@CUST_ACTUAL AND OC=@OC2
    OPEN PEDIDOS  
    FETCH NEXT FROM PEDIDOS INTO @CUSTOMER_ID ,@ID_CURSOR,@DESIRED_SHIP_DATE,@TIPO,@TOLERANCIA,@REF_COTIZA,@OC,@CARTILLA,@FECHADESPACHO
  
    WHILE @@FETCH_STATUS = 0  
    BEGIN  





   SET @SQL =N' insert into '+@BASE+'.DBO.[CUST_ORDER_LINE] 
                    (CUST_ORDER_ID, LINE_NO, PART_ID, CUSTOMER_PART_ID, LINE_STATUS, ORDER_QTY, USER_ORDER_QTY, SELLING_UM, UNIT_PRICE, TRADE_DISC_PERCENT, EST_FREIGHT, 
                    COMMISSION_PCT, MISC_REFERENCE, PRODUCT_CODE, COMMODITY_CODE, DRAWING_ID, DRAWING_REV_NO, GL_REVENUE_ACCT_ID, TOTAL_ACT_FREIGHT, TOTAL_SHIPPED_QTY, 
                    TOTAL_USR_SHIP_QTY, TOTAL_AMT_SHIPPED, TOTAL_AMT_ORDERED, WAREHOUSE_ID, WIP_VAS_UNIT_PRICE, Type, ALLOCATED_QTY, FULFILLED_QTY, ACCEPT_EARLY, DAYS_EARLY, 
                    USER_2, ORIG_STAGE_REVISION_ID, STATUS_EFF_DATE, SITE_ID, USER_1,VAT_CODE,PROMISE_DATE,PROMISE_DEL_DATE,DESIRED_SHIP_DATE,USER_3,USER_5) 
 SELECT '''+@ID_O+''' AS CUST_ORDER_ID, 
                     '''+CONVERT(VARCHAR,@LINE)+''' AS LINE_NO, 
                     P.ID AS PART_ID, 
                     '''', 
                     ''A'' AS LINE_STATUS, 
                     CONVERT(DECIMAL(14, 4),CANTIDAD) AS ORDER_QTY, 
                     CANTIDAD  AS USER_ORDER_QTY, 
                     P.STOCK_UM AS SELLING_UM, 
                     (COSTO/0.82)  AS UNIT_PRICE, 
                     0.00 AS TRADE_DISC_PERCENT, 
                     0.00 AS EST_FREIGHT, 
                     0.00 AS COMMISSION_PCT, 
                     Cast(P.DESCRIPTION as varchar(230)) AS MISC_REFERENCE, 
                     P.PRODUCT_CODE, 
                     P.COMMODITY_CODE, 
                     P.DRAWING_ID, 
                     P.DRAWING_REV_NO, 
                     ''5010201-50-01'' AS GL_REVENUE_ACCT_ID, 
                     0.00 AS TOTAL_ACT_FREIGHT, 
                     0.0000 AS TOTAL_SHIPPED_QTY, 
                     0.0000 AS TOTAL_USR_SHIP_QTY, 
                     0.00 AS TOTAL_AMT_SHIPPED, 
                     CANTIDAD  AS TOTAL_AMT_ORDERED, 
                     case (SELECT ID FROM '+@BASE+'.DBO.SITE) when ''TERCA'' then ''BOD-RD-PT'' when ''TEXPO'' then ''RE-FISCAL''  else '''' end AS WAREHOUSE_ID, 
                     0.000000 AS WIP_VAS_UNIT_PRICE, 
                     NULL AS TYPE, 
                     0.0000 AS ALLOCATED_QTY, 
                     0.0000 AS FULFILLED_QTY, 
                     (SELECT ACCEPT_EARLY FROM '+@BASE+'.DBO.CUSTOMER WHERE ID = '''+@CUSTOMER_ID+''') AS ACCEPT_EARLY, 
                     (SELECT DAYS_EARLY FROM '+@BASE+'.DBO.CUSTOMER WHERE ID ='''+@CUSTOMER_ID+''') AS DAYS_EARLY, 
                     '''+@REF_COTIZA+''' AS USER_2, 
                     ''RELEASE 0'' AS ORIG_STAGE_REVISION_ID, 
                     GETDATE() AS STATUS_EFF_DATE, 
                     (SELECT ID FROM '+@BASE+'.DBO.SITE) AS SITE_ID, 
                     '''' as USER_1,
					 (SELECT VAT_CODE FROM '+@BASE+'.DBO.CUSTOMER WHERE ID = '''+@CUSTOMER_ID+''') VAT_CODE,
					 CONVERT(DATE,'''+@FECHADESPACHO+'''),
					 CONVERT(DATE,'''+@FECHADESPACHO+'''),
					  CONVERT(DATE,'''+@FECHADESPACHO+'''),
					 '''+@TIPO+''',
					 ''CALIDAD''
					 
                     FROM '+@BASE+'.DBO.PART P  INNER JOIN TER_COM_PEDIDOS ON P.ID=PART_ID WHERE CLIENTE ='''+@CUST_ACTUAL+''' AND  ESTADO IN (''NUEVO'',''AUTORIZADO'') AND TER_COM_PEDIDOS.ID='+CONVERT(VARCHAR,@ID_CURSOR)+'  AND IDUSUARIO='''+@USUARIO+''''
--select @SQL
 EXEC  sp_executeSQL  @SQL
 SET @Error=@@ERROR
 IF (@Error<>0) GOTO TratarError


 
 UPDATE TER_COM_PEDIDOS SET ESTADO='PROCESADO',PEDIDO=@ID_O WHERE ID=@ID_CURSOR
SET @Error=@@ERROR
 IF (@Error<>0) GOTO TratarError
 UPDATE TERMO.DBO.CUSTOMER_ORDER SET USER_4=@TOLERANCIA WHERE ID=@ID_O
 SET @Error=@@ERROR
 IF (@Error<>0) GOTO TratarError

 UPDATE C SET  C.DESIRED_SHIP_DATE=CONVERT(DATE,@FECHADESPACHO),
 C.PROMISE_DATE=CONVERT(DATE,FECHA_ENTREGA,103) ,
 C.PROMISE_DEL_DATE=CONVERT(DATE,FECHA_ENTREGA,103) FROM TERMO.DBO.CUSTOMER_ORDER   C INNER JOIN TER_COM_PEDIDOS T ON C.ID=@ID_O 
 AND T.ID =@ID_CURSOR 

  SET @LINE=@LINE+1

  SET @CARTILLAS=@CARTILLA
         FETCH NEXT FROM PEDIDOS INTO @CUSTOMER_ID ,@ID_CURSOR,@DESIRED_SHIP_DATE,@TIPO,@TOLERANCIA,@REF_COTIZA,@OC,@CARTILLA,@FECHADESPACHO
        END  
  
    CLOSE PEDIDOS  
    DEALLOCATE PEDIDOS  

	INSERT INTO TERMO.[dbo].[NOTATION]  VALUES ('CO',@ID_O,GETDATE(),cast(  convert (NVARCHAR(MAX), @CARTILLAS) AS  varbinary (max)))
	 SET @SQL =' UPDATE '+@BASE+'.DBO.NEXT_NUMBER_GEN SET NEXT_NUMBER=NEXT_NUMBER+1 WHERE TABLE_NAME = ''CUSTOMER_ORDER'' and SITE_ID=(select top 1 ID from '+@BASE+'.DBO.site)'

 EXEC  sp_executeSQL  @SQL
 SET @Error=@@ERROR
 IF (@Error<>0) GOTO TratarError
	 FETCH NEXT FROM PEDIDOS1 INTO  @CUSTOMER_ID2,@OC2,@CUST_ACTUAL
        END  
  
    CLOSE PEDIDOS1  
    DEALLOCATE PEDIDOS1 

drop table #TEMP


COMMIT TRAN
TratarError:
If(@@Error<>0 )
	BEGIN
	PRINT 'Ha ecorrido un error. Abortamos la transacción'
	ROLLBACK TRAN
	END
END
