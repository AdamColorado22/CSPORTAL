USE [TERMOAPP]
GO
/****** Object:  Trigger [dbo].[TGG_COM_UPDATE]    Script Date: 12/06/2023 21:37:46 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
--SELECT * FROM TER_COM_PEDIDOS

ALTER TRIGGER [dbo].[TGG_COM_UPDATE]
   ON  [dbo].[TER_COM_PEDIDOS]
   FOR INSERT,UPDATE
AS 
DECLARE 
@ID INT,
@CLIENTE VARCHAR(50),
@OC VARCHAR(50),
@PART_ID VARCHAR(50),
@REF_COTIZACION VARCHAR(50),
@DUI VARCHAR(50),
@CANTIDAD DECIMAL(18,2),
@COSTO DECIMAL(18,2),
@MARGEN DECIMAL(18,2)

BEGIN
SELECT @ID=ID,@CLIENTE=CLIENTE,@OC=OC,@PART_ID=PART_ID ,@REF_COTIZACION=REF_COTIZACION,@DUI=DUI ,@CANTIDAD=CANTIDAD FROM INSERTED;

IF EXISTS(SELECT COMMODITY_CODE,STOCK_UM,1 FROM TERMO.DBO.PART   WHERE ID=@PART_ID)
BEGIN
UPDATE T SET  T.COMMODITY_CODE=Q.COMMODITY_CODE  FROM TER_COM_PEDIDOS T INNER JOIN  TERMO.DBO.PART Q ON T.PART_ID=Q.ID
WHERE T.PART_ID=@PART_ID AND T.ID=@ID

--VALIDACION DE UN
IF NOT EXISTS(SELECT *  FROM TER_COM_PEDIDOS T INNER JOIN  TERMO.DBO.PART Q ON T.PART_ID=Q.ID
WHERE T.PART_ID=@PART_ID AND T.ID=@ID  AND T.UN=Q.STOCK_UM )
BEGIN

UPDATE T SET FC=U.CONVERSION_FACTOR FROM TERMOAPP.DBO.TER_COM_PEDIDOS T  INNER JOIN TERMO.DBO.PART  P ON P.ID = T.PART_ID  
INNER JOIN TERMO.[dbo].[UNITS_CONVERSION] U   ON  P.STOCK_UM= U.FROM_UM AND T.UN=U.TO_UM WHERE T.ID=@ID

END
ELSE
BEGIN
UPDATE T SET FC=Q.WEIGHT FROM TER_COM_PEDIDOS T INNER JOIN  TERMO.DBO.PART Q ON T.PART_ID=Q.ID
WHERE T.PART_ID=@PART_ID AND T.ID=@ID

END

IF EXISTS (SELECT * FROM TER_COM_PEDIDOS T INNER JOIN  TER_COM_MARGEN Q ON T.COMMODITY_CODE=Q.NOMBRE AND T.CLIENTE=Q.CLIENTE
WHERE  T.ID=@ID AND T.MARGEN <Q.MARGEN and T.ESTADO='NUEVO')
BEGIN
UPDATE TER_COM_PEDIDOS SET ESTADO='PENDIENTE' WHERE ID=@ID
END
END

IF EXISTS(SELECT CUST_ID,SIC_CODE,SIC_ALT_1,* FROM TERMO.DBO.V_ACCOUNT  WHERE CUST_ID= @CLIENTE )
BEGIN
UPDATE T SET  T.SEGMENTO=(SELECT DESCRIPTION FROM TERMO.[dbo].[SIC] WHERE CODE=Q.SIC_CODE ) ,T.CLUSTER=(SELECT DESCRIPTION FROM TERMO.[dbo].[SIC] WHERE CODE=Q.SIC_ALT_1 ) FROM TER_COM_PEDIDOS T INNER JOIN  TERMO.DBO.V_ACCOUNT  Q ON T.CLIENTE=Q.CUST_ID
WHERE T.DUI=@DUI AND T.ID=@ID


END


IF EXISTS(SELECT * FROM TERMO.DBO.QUOTE_PRICE  WHERE QUOTE_ID= @REF_COTIZACION )
BEGIN

SELECT TOP 1 @COSTO=CALC_UNIT_COST FROM TERMO.DBO.QUOTE_PRICE WHERE QUOTE_ID=@REF_COTIZACION
AND QTY =@CANTIDAD ORDER BY ROWID DESC

UPDATE T SET  T.COSTO=@COSTO ,MARGEN=(1-(@COSTO/PRECIO))*100  FROM TER_COM_PEDIDOS T INNER JOIN  TERMO.DBO.QUOTE_PRICE   Q ON T.REF_COTIZACION=Q.QUOTE_ID
WHERE T.REF_COTIZACION=@REF_COTIZACION  AND T.ID=@ID


END
--ELSE
--BEGIN
--UPDATE TER_COM_PEDIDOS SET ESTADO='PENDIENTE' WHERE ID=@ID
--END



END
